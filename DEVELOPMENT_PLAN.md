# PHP FFI llhttp バインディング開発計画

## プロジェクト概要

llhttp C ライブラリの PHP FFI バインディングを作成し、オブジェクト指向かつイベント駆動型の HTTP パーサーを提供する。

## 開発フェーズ

### フェーズ 1: 基盤構築 (高優先度)

#### 1.1 技術調査・設計
- [ ] PHP FFI の機能とlimitationの調査
- [ ] llhttp ライブラリの API とデータ構造の分析
- [ ] プロジェクトアーキテクチャとクラス設計

#### 1.2 プロジェクト初期設定
- [ ] composer.json 作成（依存関係、autoloader設定）
- [ ] ディレクトリ構造作成 (src/, tests/, examples/)
- [ ] 開発ツール設定（PHPUnit, PHPStan, CodeSniffer）

#### 1.3 コア実装
- [ ] llhttp FFI ラッパーの基本実装
- [ ] イベント駆動パーサーインターフェースの作成
- [ ] 基本的な例外処理システム

### フェーズ 2: パーサー機能実装 (中優先度)

#### 2.1 HTTPリクエストパーサー
- [ ] TYPE_REQUEST パーサーの実装
- [ ] イベントコールバック実装:
  - messageBegin
  - header
  - headersComplete
  - body
  - messageComplete

#### 2.2 HTTPレスポンスパーサー
- [ ] TYPE_RESPONSE パーサーの実装
- [ ] レスポンス固有のイベント処理

#### 2.3 状態管理機能
- [ ] pause() / resume() メソッドの実装
- [ ] パーサーステートの管理

### フェーズ 3: 品質・拡張機能 (低優先度)

#### 3.1 テスト・品質保証
- [ ] 包括的な単体テスト作成
- [ ] 統合テスト（実際のHTTPデータでのテスト）
- [ ] エラーケースのテスト
- [ ] メモリリーク検出

#### 3.2 PSR-7統合
- [ ] PSR-7 Request/Response オブジェクト生成ヘルパー
- [ ] 既存PSR-7実装との連携機能

#### 3.3 ドキュメント・最適化
- [ ] 使用例とサンプルコード作成
- [ ] API ドキュメント生成
- [ ] パフォーマンス最適化
- [ ] ベンチマーク作成

## 技術的課題

### FFI関連
- C構造体とPHPオブジェクトのマッピング
- メモリ管理（ガベージコレクション対応）
- エラーハンドリング（CエラーからPHP例外への変換）

### パフォーマンス
- イベントコールバックのオーバーヘッド最小化
- メモリ使用量の最適化
- 大きなHTTPメッセージの効率的な処理

### 互換性
- 異なるPHPバージョンでの動作確認
- 様々なOS環境での llhttp ライブラリロード

## 成功指標

1. **機能完全性**: spec.md で定義された全機能の実装
2. **パフォーマンス**: 既存PHPパーサーと比較して優位性を確保
3. **使いやすさ**: 直感的なAPIと豊富なドキュメント
4. **信頼性**: 包括的なテストとエラーハンドリング

## 依存関係

### 必須
- PHP 8.0+ (FFI拡張有効)
- llhttp C ライブラリ
- Composer

### 開発時
- PHPUnit (テスト)
- PHPStan (静的解析)
- PHP CodeSniffer (コーディング規約)

## リスク要因

1. **FFI の制限**: PHP FFI の機能制限により設計変更が必要になる可能性
2. **llhttp API変更**: アップストリームの変更による影響
3. **パフォーマンス**: 期待される性能が達成できない可能性
4. **メモリ管理**: Cライブラリとの連携での メモリリーク

## マイルストーン

- **M1 (2週間)**: フェーズ1完了 - 基本的なFFIラッパー動作
- **M2 (4週間)**: フェーズ2完了 - HTTPリクエスト/レスポンス解析機能
- **M3 (6週間)**: フェーズ3完了 - 本格運用可能な状態

## 次のステップ

1. PHP FFI とllhttp の技術調査開始
2. プロジェクト構造の詳細設計
3. composer.json 作成とプロジェクト初期化